## 计算机原理

## 《程序是怎样跑起来的》

1. CPU
   1. 寄存器:寄存器可用来暂存指令、数据等处理对象，有限高速存储部件，暂存指令、数据&地址, 一个CPU一般有10~20个寄存器，在程序员看来“CPU是寄存器的集合体”，CPU 优先读写寄存器，再由寄存器跟内存交换数据。寄存器不依靠地址区分数据，而依靠名称。每一个寄存器都有自己的名称，我们告诉 CPU 去具体的哪一个寄存器拿数据，这样的速度是最快的。有人比喻寄存器是 CPU 的零级缓存。
   2. 控制器：控制器是CPU的组成部分，用于协调和控制计算机的运行，涉及程序计数、时序控制、指令编译寄存等工作, 负责把内存上的指令、数据等读入寄存器，并根据指令的执行结果来控制整个计算机。
   3. 运算器: 运算器负责运算从内存读入寄存器的数据。时钟负责发出CPU开始计时的时钟信号
   4. 时钟￼

2. 内存：通常所说的内存指的是计算机的主存储器（main memory）￼，简称主存。主存通过控制芯片等与CPU相连，主要负责存储指令和数据。主存由可读写的元素构成，每个字节（1字节=8位）都带有一个地址编号。CPU可以通过该地址读取主存中的指令和数据，当然也可以写入数据。但有一点需要注意，主存中存储的指令和数据会随着计算机的关机而自动清除。


![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320095436.png)




### 存储器

逻辑存储器

![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320103422.png)


### 内存

![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320162229.png)


内存是计算机结构中最主要的一个存储器，仅此而已。存储器不等于内存，比如显卡中的显存也属于存储器，所以存储器包括了内存、显存等多种类型的存储器。在一台PC机中，内存的作用仅次于CPU。离开了内存，性能再好的CPU也无法工作。磁盘不同于内存，磁盘中的数据或程序如果不讲到内存中去，它就无法被CPU使用。所以，学习汇编语言基本上就是在学习CPU如何调用并使用内存中的数据。

程序运行的时候，操作系统会给它分配一段内存，用来储存程序和运行产生的数据。这段内存有起始地址和结束地址，比如从0x1000到0x8000，起始地址是较小的那个地址，结束地址是较大的那个地址。



##### 内存模型：Heap堆

![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320162156.png)

这种因为用户主动请求而划分出来的内存区域，叫做 Heap（堆）。它由起始地址开始，从低位（地址）向高位（地址）增长。Heap 的一个重要特点就是不会自动消失，必须手动释放，或者由垃圾回收机制来回收。

##### 内存模型：Stack

![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320162322.png)

除了 Heap 以外，其他的内存占用叫做 Stack（栈）。简单说，Stack 是由于函数运行而临时占用的内存区域。

**Stack 是由内存区域的结束地址开始，从高位（地址）向低位（地址）分配**。比如，内存区域的结束地址是0x8000，第一帧假定是16字节，那么下一次分配的地址就会从0x7FF0开始；第二帧假定需要64字节，那么地址就会移动到0x7FB0。

![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320162524.png)


等到add_a_and_b运行结束，它的帧就会被回收，系统会回到函数main刚才中断执行的地方，继续往下执行。通过这种机制，就实现了函数的层层调用，并且每一层都能使用自己的本地变量。（这里栈底是0x8000）

所有的帧都存放在 Stack，由于帧是一层层叠加的，所以 Stack 叫做栈。生成新的帧，叫做"入栈"，英文是 push；栈的回收叫做"出栈"，英文是 pop。Stack 的特点就是，最晚入栈的帧最早出栈（因为最内层的函数调用，最先结束运行），这就叫做"后进先出"的数据结构。每一次函数执行结束，就自动释放一个帧，所有函数执行结束，整个 Stack 就都释放了。



### 数据总线

CPU与存储器之间的数据信息传输是通过数据总线来完成的。数据总线的宽度决定了CPU和外界的数据传输速度。可以把数据总线类比成高速公路，路面上的车道数越多，则通车的速度就更快。举例说明，8088CPU的数据总线宽度是8位（即有8根数据总线），如果它要把 8D99H 这个数据传递至存储器，则需要传递两次，先把低位 99 传递过去，再把高位的 8D 传递过去；如果是 8086CPU，则只需要一次传递即可把 8D99H 传递至存储器，因为 8086CPU 的数据总线宽度是 16 位（即有16根数据总线）的。数据总线的宽度，是决定CPU运算速度的因素之一（当今的CPU之所以工作速度越来越快，这不仅仅与数据总线宽度越来越宽有关，还与寄存器、二级缓存数量的增加有关，还与“打孔->计电器->电子管->晶体管”的技术发展有关）。

![](https://pic-mike.oss-cn-hongkong.aliyuncs.com/Blog/20220320103610.png)


### 指令和数据
指令和数据是应用上的概念，同一串二进制代码，可以是指令，也可以是数据，这决定于我们的程序设计。如下示例：

```dart
1000100111011000
```

当被应用为数据时，它等于 89D8H，H 表示是十六进制。当被应用为指令时，它指的是 MOV AX, BX。
不难看出，同一串二进制代码，应用不同，既可以作为指令使用，也可以作为数据来使用。



## Ref

1. [汇编语言入门教程 - 阮一峰的网络日志](https://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html)

